# Release Notes: Hybrid Search & RRF Implementation

**Дата**: 2026-01-07
**Задача**: [Техническое задание: Hybrid Search + RRF]

## Обзор
В этом обновлении мы значительно улучшили качество поиска в RAG-системе, объединив семантический поиск (Embeddings) с поиском по ключевым словам (Full-Text Search) и применив алгоритм ранжирования Reciprocal Rank Fusion (RRF).

## Что добавлено (New Features)

### 1. Поиск по ключевым словам (Keyword Search)
*   **Технология**: Postgres Full-Text Search (FTS).
*   **Реализация**:
    *   Создан **GIN индекс** для поля `chunks.content` для ускорения текстового поиска.
    *   Добавлена RPC-функция **`match_chunks_keyword`** в базу данных, использующая `websearch_to_tsquery` для обработки запросов.

### 2. Гибридный движок поиска (Hybrid Search Engine)
*   **Параллельное выполнение**: Backend теперь выполняет семантический и ключевой поиск одновременно (асинхронно), сокращая время ответа.
*   **Алгоритм RRF (Reciprocal Rank Fusion)**: Результаты двух поисков объединяются по формуле `1 / (rank + k)`, что позволяет поднимать вверх документы, найденные обоими методами, даже если их индивидуальные оценки ниже.

### 3. Прозрачность и Логирование
*   **Mini-Report**: В логи сервера (`stdout`) теперь выводится подробный отчет для каждого запроса:
    *   Top-5 Semantic matches (с cosine distance).
    *   Top-5 Keyword matches (с ts_rank).
    *   Top-3 Fused results (с итоговым RRF score).

## Что изменено (Changes & Fixes)

### 1. Инфраструктура и Сборка
*   **Makefile**: Исправлена ошибка `ModuleNotFoundError`. Команды `make install`, `make run` теперь явно используют бинарные файлы из виртуального окружения (`venv/bin/...`), гарантируя правильный запуск приложения.
*   **Setup**: Добавлена команда `make venv` для быстрой настройки окружения.

### 2. API Контракты
*   **POST /chat**:
    *   Структура ответа `sources` сохранена, но поле `similarity` теперь содержит **RRF Score** (взвешенную оценку релевантности), а не просто косинусное сходство.

### 3. Документация
*   Обновлены `README.md` и `RUN_INSTRUCTIONS.md` с актуальными командами запуска.
*   Обновлена `docs/architecture.md` с описанием гибридного пайплайна.
*   Обновлена `docs/setup.md` с инструкциями по миграции БД (`sql/02_hybrid_search.sql`).
